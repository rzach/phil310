% phil310mcgill.tex
% master file to produce text for McGill's Phil 310

% we're compiling from main directory
\newcommand{\olpath}{../../}

\usepackage{mathpazo}
\usepackage[scaled=0.95]{helvet}
\usepackage{courier}
\linespread{1.05} % Palatino looks better with this

\makeatletter
\addtolength\paperwidth{-2in}
\addtolength\stockwidth{-2in}
\addtolength\paperheight{-2in}
\addtolength\stockheight{-2in}
  \setlength\@tempdima       {\paperwidth}
  \addtolength\@tempdima     {-\textwidth}
  \setlength\oddsidemargin   {.5\@tempdima}
  \setlength\marginparwidth  {.5\@tempdima}
  \addtolength\marginparwidth{-\marginparsep}
  \addtolength\marginparwidth{-0.4in}
\setlength{\spinemargin}{\oddsidemargin}
\setlrmargins{\spinemargin}{*}{*}
\addtolength\uppermargin{-1in}
\setulmargins{\uppermargin}{*}{*}

\makeatother

\checkandfixthelayout

\usepackage[pdftex,breaklinks,bookmarks,bookmarksopen,bookmarksopenlevel=1,colorlinks,linkcolor=blue]{hyperref}

\def\oljobname{phil310mcgill}
\input{\olpath/sty/open-logic.sty}

% Defer problems

\makeatletter

\RequirePackage{etoolbox}
\RequirePackage{answers}

\def\solutionextension{prb}

\csundef{prob}
\csundef{endprob}
\csundef{probtag}
\csundef{endprobtag}

\Newassociation{prob}{probdeferred}{\jobname}
\Newassociation{probtag}{probdeferredtag}{\jobname}

% Redefine probdeferred as a theorem environment
%\csundef{probdeferred}
%\csundef{endprobdeferred}
%\csundef{c@probdeferred}



\renewenvironment{probdeferred}[1]{\begin{probd}}{\end{probd}}
%\renewenvironment{probdeferredtag}[2]{\def\probtags#2\iftag\probtags{\begin{probd}}{\supressenv{probdeferredtag}}}{\iftag\probtags{\end{probd}}{}}
\renewenvironment{probdeferredtag}[2]{\begin{probd}}{\end{probd}}

\declaretheorem[
  style=definition, numbered=yes,
  name={Problem}]{probd}
% answers writes current label as argument
%\apptocmd{\probdeferred}{\@gobble}{}{}
\def\theprobd{\probch.\arabic{probd}}

  \Opensolutionfile{\jobname}

% at the end of a \chapter command, open the solution file 
\renewcommand\memendofchapterhook{%
  \Writetofile{\jobname}{\protect\section*{Problems for Chapter~\thechapter}\protect\def\protect\probch{\thechapter}\protect\setcounter{probd}{0}}}

\makeatother

%\includeonly{frontmatter,part1}
%\includeonly{part2}
%\includeonly{part3}
%\includeonly{part4}
%\includeonly{part5}

\let\cleartorecto\newpage

\begin{document}

\include{frontmatter}

\mainmatter

\include{part1}

\include{part2}

\include{part3}

\include{part4}

\include{part5}

\Closesolutionfile{\jobname}

\backmatter

\chapter{Problems}

  \Readsolutionfile{\jobname}

\end{document}

